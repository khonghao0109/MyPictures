name: Build manifest

on:
  push:
    branches: ["main"]

jobs:
  build:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate docs/manifest.json from docs/media
        run: |
          python - << 'PY'
          import os, json, re

          IMAGE_EXTS = {".jpg",".jpeg",".png",".webp",".gif"}
          VIDEO_EXTS = {".mp4",".mov",".mkv",".avi",".webm"}

          def natural_key(s: str):
            return [int(t) if t.isdigit() else t.lower() for t in re.split(r"(\d+)", s)]

          MEDIA_ROOT = os.path.join("docs", "media")
          os.makedirs(MEDIA_ROOT, exist_ok=True)

          manifest = {"albums": []}

          album_folders = sorted(
            [d for d in os.listdir(MEDIA_ROOT) if os.path.isdir(os.path.join(MEDIA_ROOT, d))],
            key=natural_key
          )

          for folder in album_folders:
            folder_path = os.path.join(MEDIA_ROOT, folder)

            files = sorted(
              [f for f in os.listdir(folder_path)
               if os.path.splitext(f)[1].lower() in (IMAGE_EXTS | VIDEO_EXTS)],
              key=natural_key
            )

            images, videos = [], []
            for f in files:
              ext = os.path.splitext(f)[1].lower()
              rel = f"./media/{folder}/{f}"  # đúng khi publish /docs
              (images if ext in IMAGE_EXTS else videos).append(rel)

            # (Tuỳ chọn) metadata album
            title = folder
            description = ""
            embeds = []
            meta_path = os.path.join(folder_path, "album.json")
            if os.path.isfile(meta_path):
              try:
                with open(meta_path, "r", encoding="utf-8") as meta_f:
                  meta = json.load(meta_f)
                  title = meta.get("title", title)
                  description = meta.get("description", description)
                  embeds = meta.get("embeds", embeds) if isinstance(meta.get("embeds", embeds), list) else embeds
              except Exception:
                pass

            manifest["albums"].append({
              "folder": folder,
              "title": title,
              "description": description,
              "images": images,
              "videos": videos,
              "embeds": embeds
            })

          os.makedirs("docs", exist_ok=True)
          with open(os.path.join("docs", "manifest.json"), "w", encoding="utf-8") as out:
            json.dump(manifest, out, ensure_ascii=False, indent=2)

          print(f"generated docs/manifest.json with {len(manifest['albums'])} albums")
          PY

      - name: Commit docs/manifest.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/manifest.json
          git commit -m "Auto-generate manifest.json" || echo "No changes"
          git push
