name: Build manifest

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate manifest.json
        run: |
          python - << 'PY'
          import os, json

          ALBUMS = [
              ("AoDaiTet", "ðŸ‘˜ Ão DÃ i Táº¿t", "Dá»‹p Táº¿t NguyÃªn ÄÃ¡n â€” váº» Ä‘áº¹p Ã¡o dÃ i truyá»n thá»‘ng trong khÃ´ng khÃ­ mÃ¹a xuÃ¢n."),
              ("YenTu29_01", "â›°ï¸ HÃ nh TrÃ¬nh YÃªn Tá»­ (29/01)", "Trekking + hÃ nh hÆ°Æ¡ng â€” nÃºi rá»«ng, mÃ¢y mÃ¹, chÃ¹a chiá»n vÃ  khoáº£nh kháº¯c cá»§a nhÃ³m."),
              ("DoiSong_ThienNhien", "ðŸŒ¿ Äá»i Sá»‘ng & ThiÃªn NhiÃªn", "Nhá»¯ng khoáº£nh kháº¯c bÃ¬nh dá»‹: Ä‘á»i thÆ°á»ng, Ã¡nh sÃ¡ng, cÃ¢y cá», phong cáº£nh."),
              ("PhaoHoaDHD_XIV", "ðŸŽ† PhÃ¡o Hoa DHD XIV", "21:30 â€” 23/01/2026 â€¢ Cung Thiáº¿u nhi. áº¢nh + video sá»± kiá»‡n (video nhÃºng Ä‘á»ƒ phÃ¡t mÆ°á»£t)."),
          ]

          IMAGE_EXTS = {".jpg",".jpeg",".png",".webp",".gif"}
          VIDEO_EXTS = {".mp4",".mov",".mkv",".avi",".webm"}

          os.makedirs("docs", exist_ok=True)
          manifest = {"albums": []}

          for folder, title, desc in ALBUMS:
            if not os.path.isdir(folder): 
              continue
            files = sorted([f for f in os.listdir(folder) if os.path.splitext(f)[1].lower() in IMAGE_EXTS|VIDEO_EXTS])
            images, videos = [], []
            for f in files:
              ext = os.path.splitext(f)[1].lower()
              rel = f"../{folder}/{f}"
              (images if ext in IMAGE_EXTS else videos).append(rel)
            manifest["albums"].append({
              "folder": folder,
              "title": title,
              "description": desc,
              "images": images,
              "videos": videos,
              "embeds": []
            })

          with open("docs/manifest.json","w",encoding="utf-8") as out:
            json.dump(manifest, out, ensure_ascii=False, indent=2)
          print("generated docs/manifest.json")
          PY

      - name: Commit manifest.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/manifest.json
          git commit -m "Auto-generate manifest.json" || echo "No changes"
          git push
